{% extends "layout.html" %}

{% block content %}
<div class="agents-view">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">Agents</h1>
        <button id="create-agent-btn" class="btn btn-primary">
            <i class='bx bx-plus'></i> Create Agent
        </button>
    </div>
    
    <!-- Agent Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Agents</h5>
                    <div class="metric-display">
                        <i class='bx bx-bot'></i>
                        <h2 id="total-agents">8</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Active Agents</h5>
                    <div class="metric-display">
                        <i class='bx bx-run'></i>
                        <h2 id="active-agents">5</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">System Agents</h5>
                    <div class="metric-display">
                        <i class='bx bx-cog'></i>
                        <h2 id="system-agents">3</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">User Agents</h5>
                    <div class="metric-display">
                        <i class='bx bx-user'></i>
                        <h2 id="user-agents">5</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Agent List -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title">Agent List</h5>
                <div class="input-group w-25">
                    <input type="text" class="form-control" placeholder="Search agents..." id="agent-search">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class='bx bx-search'></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Team</th>
                            <th>Capabilities</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="agent-list">
                        <!-- Agent list will be populated dynamically -->
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator active me-2"></div>
                                    <div>System Coordinator</div>
                                </div>
                            </td>
                            <td><span class="badge bg-info">coordinator</span></td>
                            <td><span class="badge bg-success">active</span></td>
                            <td>System Core Team</td>
                            <td>
                                <span class="badge bg-secondary">system_coordination</span>
                                <span class="badge bg-secondary">agent_management</span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class='bx bx-info-circle'></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary">
                                        <i class='bx bx-message-square-detail'></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class='bx bx-power-off'></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator active me-2"></div>
                                    <div>System Planner</div>
                                </div>
                            </td>
                            <td><span class="badge bg-info">planner</span></td>
                            <td><span class="badge bg-success">active</span></td>
                            <td>System Core Team</td>
                            <td>
                                <span class="badge bg-secondary">strategic_planning</span>
                                <span class="badge bg-secondary">task_decomposition</span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class='bx bx-info-circle'></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary">
                                        <i class='bx bx-message-square-detail'></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class='bx bx-power-off'></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator active me-2"></div>
                                    <div>Research Agent</div>
                                </div>
                            </td>
                            <td><span class="badge bg-primary">assistant</span></td>
                            <td><span class="badge bg-success">active</span></td>
                            <td>Research Team</td>
                            <td>
                                <span class="badge bg-secondary">web_research</span>
                                <span class="badge bg-secondary">data_analysis</span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class='bx bx-info-circle'></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary">
                                        <i class='bx bx-message-square-detail'></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class='bx bx-power-off'></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Agent Details Modal -->
    <div class="modal fade" id="agentDetailsModal" tabindex="-1" aria-labelledby="agentDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentDetailsModalLabel">Agent Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">ID</dt>
                                <dd class="col-sm-8" id="agent-id">a1b2c3d4</dd>
                                
                                <dt class="col-sm-4">Name</dt>
                                <dd class="col-sm-8" id="agent-name">Research Agent</dd>
                                
                                <dt class="col-sm-4">Type</dt>
                                <dd class="col-sm-8" id="agent-type">assistant</dd>
                                
                                <dt class="col-sm-4">Status</dt>
                                <dd class="col-sm-8" id="agent-status">active</dd>
                                
                                <dt class="col-sm-4">Created</dt>
                                <dd class="col-sm-8" id="agent-created">2025-04-17 12:34:56</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>Capabilities</h6>
                            <div id="agent-capabilities" class="mb-3">
                                <span class="badge bg-secondary">web_research</span>
                                <span class="badge bg-secondary">data_analysis</span>
                                <span class="badge bg-secondary">text_summarization</span>
                            </div>
                            
                            <h6>Team Assignment</h6>
                            <p id="agent-team">Research Team</p>
                        </div>
                    </div>
                    
                    <h6>Current Tasks</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="agent-tasks">
                                <tr>
                                    <td>t1234</td>
                                    <td>Research latest LLM advancements</td>
                                    <td><span class="badge bg-warning">in progress</span></td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">75%</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h6>Recent Activity</h6>
                    <div id="agent-activity-log" class="activity-log">
                        <div class="activity-item">
                            <div class="activity-time">10:45 AM</div>
                            <div class="activity-content">Started researching latest LLM papers</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">10:30 AM</div>
                            <div class="activity-content">Initialized with capabilities: web_research, data_analysis</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Message Agent</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Agent Modal -->
    <div class="modal fade" id="createAgentModal" tabindex="-1" aria-labelledby="createAgentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createAgentModalLabel">Create New Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Wizard Navigation -->
                    <ul class="nav nav-pills nav-justified mb-4" id="agentWizardNav" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="quick-create-tab" data-bs-toggle="pill" data-bs-target="#quick-create" type="button" role="tab" aria-controls="quick-create" aria-selected="true">
                                <i class='bx bx-rocket'></i> Quick Create
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="custom-create-tab" data-bs-toggle="pill" data-bs-target="#custom-create" type="button" role="tab" aria-controls="custom-create" aria-selected="false">
                                <i class='bx bx-slider'></i> Advanced
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Wizard Content -->
                    <div class="tab-content" id="agentWizardContent">
                        <!-- Quick Create Tab -->
                        <div class="tab-pane fade show active" id="quick-create" role="tabpanel" aria-labelledby="quick-create-tab">
                            <div class="quick-create-section">
                                <p class="lead">Describe what you want the agent to do and we'll create it for you.</p>
                                
                                <div class="mb-4">
                                    <label for="agent-purpose-input" class="form-label">What should this agent do?</label>
                                    <textarea class="form-control" id="agent-purpose-input" rows="3" placeholder="Example: Research the latest AI developments and create a summary report"></textarea>
                                    <div class="form-text">Describe the agent's purpose and tasks in natural language. Be as specific as possible.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="agent-quick-name" class="form-label">Agent Name (optional)</label>
                                    <input type="text" class="form-control" id="agent-quick-name" placeholder="We'll generate a name if left blank">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Agent Priority</label>
                                    <div class="form-text mb-2">How important is this task? This affects resource allocation.</div>
                                    <div class="btn-group w-100" role="group" aria-label="Agent priority">
                                        <input type="radio" class="btn-check" name="agent-priority" id="priority-low" value="low" autocomplete="off">
                                        <label class="btn btn-outline-secondary" for="priority-low">Low</label>
                                        
                                        <input type="radio" class="btn-check" name="agent-priority" id="priority-medium" value="medium" autocomplete="off" checked>
                                        <label class="btn btn-outline-secondary" for="priority-medium">Medium</label>
                                        
                                        <input type="radio" class="btn-check" name="agent-priority" id="priority-high" value="high" autocomplete="off">
                                        <label class="btn btn-outline-secondary" for="priority-high">High</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Time Constraint</label>
                                    <select class="form-select" id="agent-time-constraint">
                                        <option value="none">No time constraint</option>
                                        <option value="quick">Quick result (minutes)</option>
                                        <option value="standard" selected>Standard (up to an hour)</option>
                                        <option value="thorough">Thorough research (hours or days)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Task Context & Guidance</label>
                                    <div class="accordion" id="contextAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingDataSources">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDataSources" aria-expanded="false" aria-controls="collapseDataSources">
                                                    Data Sources
                                                </button>
                                            </h2>
                                            <div id="collapseDataSources" class="accordion-collapse collapse" aria-labelledby="headingDataSources" data-bs-parent="#contextAccordion">
                                                <div class="accordion-body">
                                                    <div class="mb-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="use-web-search" checked>
                                                            <label class="form-check-label" for="use-web-search">
                                                                Web Search
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="mb-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="use-system-memory" checked>
                                                            <label class="form-check-label" for="use-system-memory">
                                                                System Memory
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="mb-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="upload-data">
                                                            <label class="form-check-label" for="upload-data">
                                                                Upload Custom Data
                                                            </label>
                                                        </div>
                                                        <div id="upload-data-container" class="mt-2 d-none">
                                                            <input type="file" class="form-control" id="data-file-upload">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingTools">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTools" aria-expanded="false" aria-controls="collapseTools">
                                                    Suggested Tools
                                                </button>
                                            </h2>
                                            <div id="collapseTools" class="accordion-collapse collapse" aria-labelledby="headingTools" data-bs-parent="#contextAccordion">
                                                <div class="accordion-body">
                                                    <p class="text-muted">Based on your description, we'll automatically select appropriate tools for this agent</p>
                                                    <div id="suggested-tools-list">
                                                        <div class="placeholder-glow">
                                                            <span class="placeholder col-12"></span>
                                                            <span class="placeholder col-12"></span>
                                                            <span class="placeholder col-12"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingOutput">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOutput" aria-expanded="false" aria-controls="collapseOutput">
                                                    Output Preferences
                                                </button>
                                            </h2>
                                            <div id="collapseOutput" class="accordion-collapse collapse" aria-labelledby="headingOutput" data-bs-parent="#contextAccordion">
                                                <div class="accordion-body">
                                                    <label class="form-label">Preferred Output Format</label>
                                                    <select class="form-select mb-3" id="output-format">
                                                        <option value="auto">Auto-detect best format</option>
                                                        <option value="text">Plain Text</option>
                                                        <option value="markdown">Markdown</option>
                                                        <option value="html">HTML</option>
                                                        <option value="json">JSON</option>
                                                        <option value="csv">CSV</option>
                                                    </select>
                                                    
                                                    <label class="form-label">Output Delivery</label>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="deliver-dashboard" checked>
                                                        <label class="form-check-label" for="deliver-dashboard">
                                                            Display on Dashboard
                                                        </label>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="deliver-email">
                                                        <label class="form-check-label" for="deliver-email">
                                                            Send via Email
                                                        </label>
                                                    </div>
                                                    <div id="email-delivery-container" class="mt-2 d-none">
                                                        <input type="email" class="form-control" id="delivery-email" placeholder="Enter email address">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="quick-team-check" checked>
                                        <label class="form-check-label" for="quick-team-check">
                                            Auto-create a team of agents if needed for this task
                                        </label>
                                    </div>
                                    <div class="form-text">For complex tasks, EvoGenesis will automatically create a team of specialized agents working together</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="human-review-check" checked>
                                        <label class="form-check-label" for="human-review-check">
                                            Require human approval for key decisions
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="agent-quick-result" class="alert alert-info d-none">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="ms-2">Analyzing your request...</span>
                                </div>
                                
                                <div id="agent-suggestion-container" class="border rounded p-3 mt-3 d-none">
                                    <h6>Suggested Solution</h6>
                                    <div id="agent-suggestion-content"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Create Tab -->
                        <div class="tab-pane fade" id="custom-create" role="tabpanel" aria-labelledby="custom-create-tab">
                            <form id="create-agent-form">
                                <div class="mb-3">
                                    <label for="agent-name-input" class="form-label">Agent Name</label>
                                    <input type="text" class="form-control" id="agent-name-input" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="agent-type-select" class="form-label">Agent Type</label>
                                    <select class="form-select" id="agent-type-select" required>
                                        <option value="">Select a type</option>
                                        <option value="assistant">Assistant</option>
                                        <option value="researcher">Researcher</option>
                                        <option value="analyst">Analyst</option>
                                        <option value="developer">Developer</option>
                                        <option value="coordinator">Coordinator</option>
                                        <option value="planner">Planner</option>
                                        <option value="critic">Critic</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <div id="custom-type-div" class="mb-3 d-none">
                                    <label for="custom-type-input" class="form-label">Custom Type Name</label>
                                    <input type="text" class="form-control" id="custom-type-input">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="agent-description-input" class="form-label">Description</label>
                                    <textarea class="form-control" id="agent-description-input" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="agent-model-select" class="form-label">Base LLM Model</label>
                                    <select class="form-select" id="agent-model-select">
                                        <option value="default">System Default</option>
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        <option value="llama-2-70b">Llama 2 (70B)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Capabilities</label>
                                    <div id="capabilities-container" class="mb-2">
                                        <!-- Dynamic capabilities selectors will be added here -->
                                        <div class="capability-item d-flex mb-2">
                                            <select class="form-select me-2 capability-select">
                                                <option value="">Select a capability</option>
                                                <option value="web_research">Web Research</option>
                                                <option value="data_analysis">Data Analysis</option>
                                                <option value="code_generation">Code Generation</option>
                                                <option value="text_summarization">Text Summarization</option>
                                                <option value="strategic_planning">Strategic Planning</option>
                                                <option value="creative_writing">Creative Writing</option>
                                            </select>
                                            <button type="button" class="btn btn-outline-danger remove-capability">
                                                <i class='bx bx-x'></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-capability-btn">
                                        <i class='bx bx-plus'></i> Add Capability
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="agent-team-select" class="form-label">Assign to Team</label>
                                    <select class="form-select" id="agent-team-select">
                                        <option value="">None (Independent Agent)</option>
                                        <!-- Teams will be loaded dynamically -->
                                    </select>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="agent-auto-improve-check" checked>
                                    <label class="form-check-label" for="agent-auto-improve-check">
                                        Allow this agent to self-improve over time
                                    </label>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-agent-submit">Create Agent</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load agents data
        loadAgents();
        
        // Subscribe to agent-related WebSocket events
        EvoGenesis.ws.subscribe(['agents', 'agents.status', 'teams']);
        
        // Setup event listeners
        document.getElementById('create-agent-btn').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('createAgentModal'));
            modal.show();
            
            // Reset the form state
            resetAgentCreateForm();
        });
        
        document.getElementById('create-agent-submit').addEventListener('click', createAgent);
        
        document.getElementById('agent-search').addEventListener('input', function() {
            filterAgents(this.value);
        });
        
        // Set up click handlers for agent details
        const agentList = document.getElementById('agent-list');
        agentList.addEventListener('click', function(e) {
            const infoButton = e.target.closest('.btn-outline-primary');
            if (infoButton) {
                const row = infoButton.closest('tr');
                const agentName = row.querySelector('td:first-child div div').textContent;
                showAgentDetails(agentName);
            }
        });
        
        // Listen for WebSocket messages
        document.addEventListener('ws-message', function(e) {
            const data = e.detail;
            
            if (data.topic === 'agents' || data.topic === 'agents.status') {
                loadAgents();
            }
        });
        
        // Set up dynamic form behavior
        setupDynamicFormBehavior();
        
        // Setup purpose input analyzer
        setupPurposeAnalyzer();
        
        // Setup agent type custom input handler
        document.getElementById('agent-type-select').addEventListener('change', function() {
            const customTypeDiv = document.getElementById('custom-type-div');
            if (this.value === 'custom') {
                customTypeDiv.classList.remove('d-none');
            } else {
                customTypeDiv.classList.add('d-none');
            }
        });
        
        // Setup capability management
        document.getElementById('add-capability-btn').addEventListener('click', addCapabilityItem);
        
        // Add event delegation for remove capability buttons
        document.getElementById('capabilities-container').addEventListener('click', function(e) {
            if (e.target.closest('.remove-capability')) {
                e.target.closest('.capability-item').remove();
            }
        });
    });
    
    function resetAgentCreateForm() {
        // Reset form fields
        document.getElementById('agent-purpose-input').value = '';
        document.getElementById('agent-quick-name').value = '';
        document.getElementById('output-format').value = 'auto';
        document.getElementById('use-web-search').checked = true;
        document.getElementById('use-system-memory').checked = true;
        document.getElementById('upload-data').checked = false;
        document.getElementById('upload-data-container').classList.add('d-none');
        document.getElementById('deliver-dashboard').checked = true;
        document.getElementById('deliver-email').checked = false;
        document.getElementById('email-delivery-container').classList.add('d-none');
        document.getElementById('quick-team-check').checked = true;
        document.getElementById('human-review-check').checked = true;
        
        // Reset radio buttons
        document.getElementById('priority-medium').checked = true;
        
        // Reset select boxes
        document.getElementById('agent-time-constraint').value = 'standard';
        
        // Hide result sections
        document.getElementById('agent-quick-result').classList.add('d-none');
        document.getElementById('agent-suggestion-container').classList.add('d-none');
        
        // Reset suggested tools
        document.getElementById('suggested-tools-list').innerHTML = `
            <div class="placeholder-glow">
                <span class="placeholder col-12"></span>
                <span class="placeholder col-12"></span>
                <span class="placeholder col-12"></span>
            </div>
        `;
        
        // Reset tab to quick create
        document.getElementById('quick-create-tab').click();
    }
    
    function setupDynamicFormBehavior() {
        // Handle upload data checkbox
        document.getElementById('upload-data').addEventListener('change', function() {
            const uploadContainer = document.getElementById('upload-data-container');
            if (this.checked) {
                uploadContainer.classList.remove('d-none');
            } else {
                uploadContainer.classList.add('d-none');
            }
        });
        
        // Handle email delivery checkbox
        document.getElementById('deliver-email').addEventListener('change', function() {
            const emailContainer = document.getElementById('email-delivery-container');
            if (this.checked) {
                emailContainer.classList.remove('d-none');
            } else {
                emailContainer.classList.add('d-none');
            }
        });
        
        // Update tools list when purpose changes
        document.getElementById('agent-purpose-input').addEventListener('input', function() {
            updateSuggestedTools(this.value);
        });
    }
    
    async function updateSuggestedTools(purpose) {
        if (!purpose || purpose.length < 10) return;
        
        const toolsList = document.getElementById('suggested-tools-list');
        
        // Show loading placeholder if not already showing
        if (!toolsList.querySelector('.placeholder')) {
            toolsList.innerHTML = `
                <div class="placeholder-glow">
                    <span class="placeholder col-12"></span>
                    <span class="placeholder col-12"></span>
                    <span class="placeholder col-12"></span>
                </div>
            `;
        }
        
        try {
            // Call the API to get suggested tools
            const result = await EvoGenesis.api.fetch('/api/tools/suggest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ purpose: purpose })
            });
            
            if (result && result.suggested_tools) {
                // Render the suggested tools
                toolsList.innerHTML = '';
                
                if (result.suggested_tools.length === 0) {
                    toolsList.innerHTML = '<p class="text-muted">No specific tools suggested for this task</p>';
                    return;
                }
                
                result.suggested_tools.forEach(tool => {
                    const toolItem = document.createElement('div');
                    toolItem.className = 'suggested-tool-item d-flex align-items-center mb-2';
                    
                    // Determine icon based on tool category
                    let iconClass = 'bx-wrench';
                    switch(tool.category) {
                        case 'data': iconClass = 'bx-table'; break;
                        case 'web': iconClass = 'bx-globe'; break;
                        case 'file': iconClass = 'bx-file'; break;
                        case 'api': iconClass = 'bx-server'; break;
                        case 'ai': iconClass = 'bx-brain'; break;
                        case 'utils': iconClass = 'bx-cog'; break;
                    }
                    
                    toolItem.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tool-${tool.id}" checked>
                            <label class="form-check-label" for="tool-${tool.id}">
                                <i class='bx ${iconClass} me-1'></i>
                                <strong>${tool.name}</strong>
                                <small class="text-muted ms-1">${tool.description}</small>
                            </label>
                        </div>
                    `;
                    
                    toolsList.appendChild(toolItem);
                });
            }
        } catch (error) {
            console.error('Error fetching suggested tools:', error);
            toolsList.innerHTML = '<p class="text-danger">Error loading suggested tools</p>';
        }
    }
    
    function setupPurposeAnalyzer() {
        const purposeInput = document.getElementById('agent-purpose-input');
        let analysisTimeout;
        
        purposeInput.addEventListener('input', function() {
            // Clear previous timeout
            clearTimeout(analysisTimeout);
            
            // Set new timeout (300ms debounce)
            analysisTimeout = setTimeout(async () => {
                const purpose = purposeInput.value;
                
                if (purpose.length < 20) return;
                
                try {
                    // Call the API to analyze the purpose
                    const result = await EvoGenesis.api.fetch('/api/agents/analyze-purpose', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ purpose: purpose })
                    });
                    
                    if (result && result.analysis) {
                        // Show suggestion container
                        const suggestionContainer = document.getElementById('agent-suggestion-container');
                        const suggestionContent = document.getElementById('agent-suggestion-content');
                        
                        suggestionContainer.classList.remove('d-none');
                        
                        // Create summary of the suggested solution
                        let suggestionHTML = '<div class="suggested-solution">';
                        
                        if (result.analysis.requires_team) {
                            suggestionHTML += `
                                <div class="alert alert-info">
                                    <i class='bx bx-info-circle'></i>
                                    <strong>Team Recommended:</strong> This task would benefit from a team of multiple specialized agents working together.
                                </div>
                            `;
                            
                            suggestionHTML += '<h6>Suggested Team Structure:</h6><ul>';
                            result.analysis.suggested_agents.forEach(agent => {
                                suggestionHTML += `<li><strong>${agent.name}</strong> - ${agent.purpose}</li>`;
                            });
                            suggestionHTML += '</ul>';
                        } else {
                            // Single agent recommendation
                            const agent = result.analysis.suggested_agents[0];
                            suggestionHTML += `
                                <p>We recommend creating a <strong>${agent.type}</strong> agent with the following capabilities:</p>
                                <ul>
                            `;
                            agent.capabilities.forEach(capability => {
                                suggestionHTML += `<li>${capability}</li>`;
                            });
                            suggestionHTML += '</ul>';
                        }
                        
                        // Add suggested name if missing
                        if (!document.getElementById('agent-quick-name').value && result.analysis.suggested_name) {
                            document.getElementById('agent-quick-name').value = result.analysis.suggested_name;
                        }
                        
                        // Add estimated completion time
                        if (result.analysis.estimated_time) {
                            suggestionHTML += `
                                <p class="mb-0"><strong>Estimated completion time:</strong> ${result.analysis.estimated_time}</p>
                            `;
                        }
                        
                        suggestionHTML += '</div>';
                        suggestionContent.innerHTML = suggestionHTML;
                    }
                } catch (error) {
                    console.error('Error analyzing purpose:', error);
                }
            }, 500);
        });
    }
    
    function addCapabilityItem() {
        const container = document.getElementById('capabilities-container');
        
        const newItem = document.createElement('div');
        newItem.className = 'capability-item d-flex mb-2';
        
        newItem.innerHTML = `
            <select class="form-select me-2 capability-select">
                <option value="">Select a capability</option>
                <option value="web_research">Web Research</option>
                <option value="data_analysis">Data Analysis</option>
                <option value="code_generation">Code Generation</option>
                <option value="text_summarization">Text Summarization</option>
                <option value="strategic_planning">Strategic Planning</option>
                <option value="creative_writing">Creative Writing</option>
            </select>
            <button type="button" class="btn btn-outline-danger remove-capability">
                <i class='bx bx-x'></i>
            </button>
        `;
        
        container.appendChild(newItem);
    }
</script>
{% endblock %}
