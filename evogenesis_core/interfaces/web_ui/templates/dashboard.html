{% extends "layout.html" %}

{% block content %}
<div class="dashboard">
    <h1 class="page-title">EvoGenesis Control Panel</h1>
    
    <!-- System Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">System Status</h5>
                    <div class="status-display">
                        <div id="system-health-indicator" class="status-indicator active"></div>
                        <h2 id="system-health-percentage">98%</h2>
                    </div>
                    <p id="system-status-message" class="text-center">All systems operational</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Active Agents</h5>
                    <div class="metric-display">
                        <i class='bx bx-bot'></i>
                        <h2 id="active-agents-count">5</h2>
                    </div>
                    <p class="text-center"><span id="total-agents-count">8</span> total agents</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Running Tasks</h5>
                    <div class="metric-display">
                        <i class='bx bx-task'></i>
                        <h2 id="running-tasks-count">3</h2>
                    </div>
                    <p class="text-center"><span id="total-tasks-count">12</span> total tasks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Memory Usage</h5>
                    <div class="metric-display">
                        <i class='bx bx-memory-card'></i>
                        <h2 id="memory-usage-percentage">42%</h2>
                    </div>
                    <p class="text-center"><span id="memory-usage-count">1.2</span> GB used</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Actions</h5>
                    <div class="quick-actions">
                        <button id="btn-create-agent" class="btn btn-primary quick-action">
                            <i class='bx bx-bot'></i>
                            <span>Create Agent</span>
                        </button>
                        <button id="btn-new-task" class="btn btn-primary quick-action">
                            <i class='bx bx-task'></i>
                            <span>Create Task</span>
                        </button>
                        <button id="btn-auto-team" class="btn btn-primary quick-action">
                            <i class='bx bx-group'></i>
                            <span>Auto-Create Team</span>
                        </button>
                        <button id="btn-tools" class="btn btn-primary quick-action">
                            <i class='bx bx-wrench'></i>
                            <span>Manage Tools</span>
                        </button>
                        <button id="btn-scan-opportunities" class="btn btn-primary quick-action">
                            <i class='bx bx-search-alt'></i>
                            <span>Scan Opportunities</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Guided Setup Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Guided Setup</h5>
                    <p>New to EvoGenesis? Let us help you get started with guided wizards:</p>
                    <div class="guided-wizards">
                        <div class="wizard-card" id="wizard-new-project">
                            <i class='bx bx-bulb'></i>
                            <h4>New Project</h4>
                            <p>Create a new AI project with auto-generated components</p>
                            <button class="btn btn-outline-primary">Start</button>
                        </div>
                        <div class="wizard-card" id="wizard-agent-team">
                            <i class='bx bx-group'></i>
                            <h4>Agent Team</h4>
                            <p>Build a specialized team of agents for your specific goal</p>
                            <button class="btn btn-outline-primary">Start</button>
                        </div>
                        <div class="wizard-card" id="wizard-tool-integration">
                            <i class='bx bx-link'></i>
                            <h4>Tool Integration</h4>
                            <p>Connect external tools and services to your agents</p>
                            <button class="btn btn-outline-primary">Start</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Teams and Recent Activities Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Active Teams</h5>
                </div>
                <div class="card-body">
                    <div id="active-teams-container">
                        <div class="team-card">
                            <div class="team-header">
                                <h6>Research Team</h6>
                                <span class="badge bg-success">Active</span>
                            </div>
                            <p>Researching the latest developments in LLM capabilities</p>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">65%</div>
                            </div>
                            <div class="team-footer">
                                <span><i class='bx bx-bot'></i> 3 agents</span>
                                <span><i class='bx bx-task'></i> 2 tasks</span>
                            </div>
                        </div>
                        <div class="team-card">
                            <div class="team-header">
                                <h6>Development Team</h6>
                                <span class="badge bg-success">Active</span>
                            </div>
                            <p>Implementing new features for the tooling system</p>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 42%;" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100">42%</div>
                            </div>
                            <div class="team-footer">
                                <span><i class='bx bx-bot'></i> 2 agents</span>
                                <span><i class='bx bx-task'></i> 1 task</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="/teams" class="btn btn-sm btn-primary">View All Teams</a>
                </div>
            </div>
        </div>
        
        <!-- Recent Activities Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Recent Activities</h5>
                </div>
                <div class="card-body">
                    <div id="activity-feed">
                        <!-- Placeholder content, will be populated dynamically -->
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class='bx bx-check-circle'></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    <span class="activity-title">Task Completed</span>
                                    <span class="activity-time">10:45 AM</span>
                                </div>
                                <p>Agent A completed task #123: Research latest LLM advancements</p>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class='bx bx-refresh'></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    <span class="activity-title">Memory Updated</span>
                                    <span class="activity-time">10:32 AM</span>
                                </div>
                                <p>Added 15 new entries to long-term memory</p>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class='bx bx-plus-circle'></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-header">
                                    <span class="activity-title">Tool Registered</span>
                                    <span class="activity-time">10:15 AM</span>
                                </div>
                                <p>New tool 'data_analyzer' added to the tooling system</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="/logs" class="btn btn-sm btn-primary">View All Activities</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Performance and Agent Network Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Task Execution Timeline</h5>
                </div>
                <div class="card-body">
                    <div id="task-timeline"></div>
                </div>
                <div class="card-footer">
                    <a href="/tasks" class="btn btn-sm btn-primary">View All Tasks</a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title">AI Assistant</h5>
                    <span class="badge bg-success">Online</span>
                </div>
                <div class="card-body">
                    <div class="assistant-container">
                        <div class="assistant-history" id="assistant-history">
                            <div class="assistant-message">
                                <div class="assistant-icon">
                                    <i class='bx bx-bot'></i>
                                </div>
                                <div class="message-content">
                                    <p>Hello! I'm your EvoGenesis AI Assistant. How can I help you today?</p>
                                    <p>You can ask me to:</p>
                                    <ul>
                                        <li>Create agents or teams for specific tasks</li>
                                        <li>Set up automated workflows</li>
                                        <li>Process and analyze data</li>
                                        <li>Explain system features and capabilities</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="assistant-input">
                            <form id="assistant-form">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="assistant-prompt" placeholder="Ask anything about EvoGenesis or what you want to accomplish...">
                                    <button class="btn btn-primary" type="submit">
                                        <i class='bx bx-send'></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity and Evolution Status -->
    <div class="row mb-4">
        <div class="col-md-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Activity</h5>
                    <div class="activity-feed" id="activity-feed">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">System Evolution</h5>
                    <div class="evolution-status">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6>Self-Evolution Status</h6>
                                <p id="evolution-status">Active (Auto)</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="evolution-toggle" checked>
                                <label class="form-check-label" for="evolution-toggle">Auto-Evolve</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Current Improvement Focus</h6>
                            <div class="focus-tags" id="improvement-focus">
                                <span class="badge bg-primary">Performance</span>
                                <span class="badge bg-success">Reliability</span>
                                <span class="badge bg-info">Tool Integration</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Pending Opportunities</h6>
                            <p id="pending-opportunities">5 opportunities need your review</p>
                            <a href="/self-evolution" class="btn btn-sm btn-outline-primary">Review</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Strategic Observatory</h5>
                    <div class="observatory-status">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6>Opportunity Detection</h6>
                                <p id="observatory-status">Active (Scanning)</p>
                            </div>
                            <div>
                                <span class="badge bg-success">5 Signal Sources</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6>Latest Opportunities</h6>
                            <ul class="list-group list-group-flush observatory-list" id="latest-opportunities">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    New market trend detected
                                    <span class="badge bg-primary rounded-pill">High</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Potential API integration
                                    <span class="badge bg-info rounded-pill">Medium</span>
                                </li>
                            </ul>
                            <a href="/observatory" class="btn btn-sm btn-outline-primary mt-2">View All</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Subscribe to WebSocket events
    document.addEventListener('ws-message', function(event) {
        const message = event.detail;
        
        // Handle different message topics
        if (message.topic === 'metrics') {
            updateDashboardMetrics(message.data);
        } else if (message.topic === 'tasks.status') {
            addActivityFromTaskEvent(message.data);
        } else if (message.topic === 'system.status') {
            updateSystemStatus(message.data);
        }
    });
    
    // Initialize WebSocket connection
    if (typeof EvoGenesis !== 'undefined' && EvoGenesis.ws) {
        EvoGenesis.ws.subscribe(['metrics', 'tasks.status', 'system.status']);
    }
    
    function updateDashboardMetrics(metrics) {
        // Update agent metrics
        if (metrics.agents) {
            $('#active-agents-count').text(metrics.agents.active);
            $('#total-agents-count').text(metrics.agents.total);
        }
        
        // Update task metrics
        if (metrics.tasks) {
            $('#running-tasks-count').text(metrics.tasks.running);
            $('#total-tasks-count').text(metrics.tasks.total);
        }
        
        // Update memory usage
        if (metrics.memory) {
            const memoryPercentage = Math.round(metrics.memory.usage_percent);
            $('#memory-usage-percentage').text(`${memoryPercentage}%`);
            
            const memoryUsageGB = (metrics.memory.usage_mb / 1024).toFixed(1);
            $('#memory-usage-count').text(memoryUsageGB);
        }
        
        // Update recent activities
        if (metrics.activities && metrics.activities.length > 0) {
            const activityFeed = $('#activity-feed');
            activityFeed.empty();
            
            metrics.activities.forEach(activity => {
                addActivityItem({
                    icon: getIconForActivityType(activity.type),
                    title: activity.title,
                    message: activity.message,
                    time: new Date(activity.timestamp * 1000).toLocaleTimeString()
                });
            });
        }
    }
    
    function getIconForActivityType(type) {
        switch (type) {
            case 'task_created':
                return 'bx bx-plus-circle';
            case 'task_started':
                return 'bx bx-play-circle';
            case 'task_completed':
                return 'bx bx-check-circle';
            case 'task_failed':
                return 'bx bx-error-circle';
            case 'agent_created':
                return 'bx bx-bot';
            case 'memory_updated':
                return 'bx bx-memory-card';
            case 'system_started':
                return 'bx bx-power-off';
            case 'system_stopped':
                return 'bx bx-stop-circle';
            default:
                return 'bx bx-info-circle';
        }
    }
    
    function addActivityFromTaskEvent(data) {
        let title = 'Task Update';
        let message = `Task updated: ${data.task_id}`;
        let icon = 'bx bx-task';
        
        if (data.event === 'task_started') {
            title = 'Task Started';
            message = `Task ${data.task_id} started`;
            icon = 'bx bx-play-circle';
        } else if (data.event === 'task_paused') {
            title = 'Task Paused';
            message = `Task ${data.task_id} paused`;
            icon = 'bx bx-pause-circle';
        } else if (data.event === 'task_stopped') {
            title = 'Task Stopped';
            message = `Task ${data.task_id} stopped`;
            icon = 'bx bx-stop-circle';
        } else if (data.event === 'task_completed') {
            title = 'Task Completed';
            message = `Task ${data.task_id} completed`;
            icon = 'bx bx-check-circle';
        }
        
        addActivityItem({
            icon: icon,
            title: title,
            message: message,            time: new Date().toLocaleTimeString()
        });
    }
    
    // Subscribe to WebSocket events
    document.addEventListener('ws-message', function(event) {
        const message = event.detail;
        
        // Handle different message topics
        if (message.topic === 'metrics') {
            updateDashboardMetrics(message.data);
        } else if (message.topic === 'tasks.status') {
            addActivityFromTaskEvent(message.data);
        } else if (message.topic === 'system.status') {
            updateSystemStatus(message.data);
        }
    });
    
    // Initialize WebSocket connection
    if (typeof EvoGenesis !== 'undefined' && EvoGenesis.ws) {
        EvoGenesis.ws.subscribe(['metrics', 'tasks.status', 'system.status']);
    }
    
    function updateDashboardMetrics(metrics) {
        // Update agent metrics
        if (metrics.agents) {
            $('#active-agents-count').text(metrics.agents.active);
            $('#total-agents-count').text(metrics.agents.total);
        }
        
        // Update task metrics
        if (metrics.tasks) {
            $('#running-tasks-count').text(metrics.tasks.running);
            $('#total-tasks-count').text(metrics.tasks.total);
        }
        
        // Update memory usage
        if (metrics.memory) {
            const memoryPercentage = Math.round(metrics.memory.usage_percent);
            $('#memory-usage-percentage').text(`${memoryPercentage}%`);
            
            const memoryUsageGB = (metrics.memory.usage_mb / 1024).toFixed(1);
            $('#memory-usage-count').text(memoryUsageGB);
        }
        
        // Update recent activities
        if (metrics.activities && metrics.activities.length > 0) {
            const activityFeed = $('#activity-feed');
            activityFeed.empty();
            
            metrics.activities.forEach(activity => {
                addActivityItem({
                    icon: getIconForActivityType(activity.type),
                    title: activity.title,
                    message: activity.message,
                    time: new Date(activity.timestamp * 1000).toLocaleTimeString()
                });
            });
        }
    }
    
    function getIconForActivityType(type) {
        switch (type) {
            case 'task_created':
                return 'bx bx-plus-circle';
            case 'task_started':
                return 'bx bx-play-circle';
            case 'task_completed':
                return 'bx bx-check-circle';
            case 'task_failed':
                return 'bx bx-error-circle';
            case 'agent_created':
                return 'bx bx-bot';
            case 'memory_updated':
                return 'bx bx-memory-card';
            case 'system_started':
                return 'bx bx-power-off';
            case 'system_stopped':
                return 'bx bx-stop-circle';
            default:
                return 'bx bx-info-circle';
        }
    }
    
    function addActivityFromTaskEvent(data) {
        let title = 'Task Update';
        let message = `Task updated: ${data.task_id}`;
        let icon = 'bx bx-task';
        
        if (data.event === 'task_started') {
            title = 'Task Started';
            message = `Task ${data.task_id} started`;
            icon = 'bx bx-play-circle';
        } else if (data.event === 'task_paused') {
            title = 'Task Paused';
            message = `Task ${data.task_id} paused`;
            icon = 'bx bx-pause-circle';
        } else if (data.event === 'task_stopped') {
            title = 'Task Stopped';
            message = `Task ${data.task_id} stopped`;
            icon = 'bx bx-stop-circle';
        } else if (data.event === 'task_completed') {
            title = 'Task Completed';
            message = `Task ${data.task_id} completed`;
            icon = 'bx bx-check-circle';
        }
        
        addActivityItem({
            icon: icon,
            title: title,
            message: message,
            time: new Date().toLocaleTimeString()
        });
    }
});
</script>
{% endblock %}
